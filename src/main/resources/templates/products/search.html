<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>상품 검색</title>
  <link rel="stylesheet" th:href="@{/css/common.css}">
  <link rel="stylesheet" th:href="@{/css/products.css}">
  <style>
    .search-container {
      max-width: 600px;
      margin: 50px auto;
      padding: 20px;
      text-align: center;
    }
    .search-box-wrapper {
      position: relative;
      width: 100%;
      display: flex;
      flex-direction: column;
      align-items: stretch;
    }
    .search-box {
      display: flex;
      gap: 10px;
      flex-direction: row;
      align-items: stretch;
      width: 100%;
    }
    .search-box input {
      flex: 1;
      width: 100%;
      box-sizing: border-box;
      padding: 12px 16px;
      font-size: 16px;
      border: 2px solid #ddd;
      border-radius: 8px 0 0 8px;
      outline: none;
      transition: border-color 0.3s;
    }
    .search-box input:focus {
      border-color: #007bff;
    }
    .search-btn {
      padding: 0 24px;
      font-size: 16px;
      background-color: #007bff;
      color: white;
      border: none;
      border-radius: 0 8px 8px 0;
      cursor: pointer;
      transition: background-color 0.3s;
    }
    .search-btn:hover {
      background-color: #0056b3;
    }
    .autocomplete-dropdown {
      display: block !important;
      position: absolute !important;
      top: 100% !important;
      left: 0 !important;
      width: 100% !important;
      background: #fff !important;
      color: #222 !important;
      z-index: 99999 !important;
      border: 2px solid #007bff !important;
      min-width: 200px !important;
      max-width: 100vw !important;
      max-height: 400px !important;
      overflow-y: auto !important;
      margin: 0 !important;
      padding: 0 !important;
      list-style: none !important;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15) !important;
      border-top: none !important;
    }
    .autocomplete-dropdown li {
      display: block !important;
      color: #222 !important;
      background: #fff !important;
      font-size: 16px !important;
      padding: 12px 16px !important;
      border-bottom: 1px solid #eee !important;
      cursor: pointer !important;
      transition: background 0.2s;
    }
    .autocomplete-dropdown li.highlighted,
    .autocomplete-dropdown li:hover {
      background-color: #e3f2fd !important;
      border-left: 4px solid #007bff !important;
    }
    .autocomplete-loading {
      padding: 16px;
      color: #007bff;
      text-align: center;
      font-size: 15px;
    }
    .autocomplete-empty {
      padding: 16px;
      color: #888;
      text-align: center;
      font-size: 15px;
    }
  </style>
</head>
<body>
  <div class="search-container">
    <h2>상품 검색</h2>
    <form id="searchForm" autocomplete="off" onsubmit="return false;">
      <div class="search-box-wrapper">
        <div class="search-box">
          <input type="text" id="searchInput" placeholder="상품명을 입력하세요... (최소 2글자)" autocomplete="off" aria-label="상품명 검색">
          <button type="submit" id="searchBtn" class="search-btn" aria-label="검색">검색</button>
        </div>
        <ul id="autocompleteList" class="autocomplete-dropdown" style="display:none"></ul>
      </div>
    </form>
  </div>
<script>
document.addEventListener('DOMContentLoaded', () => {
  const searchInput = document.getElementById('searchInput');
  const autocompleteList = document.getElementById('autocompleteList');
  const searchBtn = document.getElementById('searchBtn');
  const searchForm = document.getElementById('searchForm');
  let currentHighlight = -1;
  let suggestions = [];
  let suggestionData = [];
  let loading = false;

  function debounce(func, delay) {
    let timeout;
    return function(...args) {
      clearTimeout(timeout);
      timeout = setTimeout(() => func.apply(this, args), delay);
    };
  }

  // 자동완성 API 호출 및 결과 표시
  async function fetchAutocomplete(query) {
    if (query.length < 2) {
      hideAutocompleteList();
      return;
    }
    showLoading();
    try {
      const response = await fetch(`/api/elk/products/autocomplete/pname?prefix=${encodeURIComponent(query)}`);
      const data = await response.json();
      // data.body: [{ label: '삼성 냉장고', highlight: '<b>삼성</b> 냉장고' }, ...]
      displayAutocompleteResults(data.body || []);
    } catch (e) {
      showEmpty('네트워크 오류');
    }
  }

  // 자동완성 결과 표시
  function displayAutocompleteResults(items) {
    autocompleteList.innerHTML = '';
    suggestions = [];
    suggestionData = items;
    currentHighlight = -1;
    if (items.length === 0) {
      showEmpty('검색 결과가 없습니다.');
      return;
    }
    items.slice(0, 10).forEach((item, idx) => {
      let displayText = '';
      let valueText = '';
      if (typeof item === 'object' && item !== null) {
        displayText = item.highlight || item.label || '';
        valueText = item.label || item.highlight || '';
      } else {
        displayText = item;
        valueText = item;
      }
      if (!displayText) displayText = valueText || '알 수 없음';
      const li = document.createElement('li');
      li.innerHTML = displayText;
      li.tabIndex = -1;
      li.addEventListener('mousedown', (e) => {
        e.preventDefault();
        selectSuggestion(idx);
      });
      autocompleteList.appendChild(li);
      suggestions.push(li);
    });
    autocompleteList.style.display = 'block';
  }

  function showLoading() {
    autocompleteList.innerHTML = '<li class="autocomplete-loading">검색 중...</li>';
    autocompleteList.style.display = 'block';
    suggestions = [];
    suggestionData = [];
    currentHighlight = -1;
  }

  function showEmpty(msg) {
    autocompleteList.innerHTML = `<li class="autocomplete-empty">${msg}</li>`;
    autocompleteList.style.display = 'block';
    suggestions = [];
    suggestionData = [];
    currentHighlight = -1;
  }

  function hideAutocompleteList() {
    autocompleteList.innerHTML = '';
    autocompleteList.style.display = 'none';
    suggestions = [];
    suggestionData = [];
    currentHighlight = -1;
  }

  // 자동완성 선택
  function selectSuggestion(idx) {
    let value = '';
    const item = suggestionData[idx];
    if (typeof item === 'object' && item !== null) {
      // label이 null/undefined/공백만 있는 경우도 방어
      if (item.label && item.label.replace(/\s/g, '').length > 0) {
        value = item.label;
      } else if (item.highlight) {
        // highlight에서 HTML 태그 제거 (정규식 + DOM 방식 병행)
        const tempDiv = document.createElement('div');
        tempDiv.innerHTML = item.highlight;
        value = tempDiv.textContent || tempDiv.innerText || '';
        value = value.replace(/<[^>]*>/g, '');
      } else {
        value = '';
      }
    } else {
      value = item;
    }
    // 혹시라도 value에 태그가 남아있으면 한 번 더 제거
    value = typeof value === 'string' ? value.replace(/<[^>]*>/g, '') : value;
    console.log('자동완성 선택 value:', value);
    searchInput.value = value;
    hideAutocompleteList();
    performSearch(value);
  }

  function handleKeydown(event) {
    if (suggestions.length === 0) return;
    if (currentHighlight > -1) {
      suggestions[currentHighlight].classList.remove('highlighted');
    }
    if (event.key === 'ArrowDown') {
      currentHighlight = (currentHighlight + 1) % suggestions.length;
      event.preventDefault();
    } else if (event.key === 'ArrowUp') {
      currentHighlight = (currentHighlight - 1 + suggestions.length) % suggestions.length;
      event.preventDefault();
    } else if (event.key === 'Enter') {
      if (currentHighlight > -1) {
        selectSuggestion(currentHighlight);
      } else {
        performSearch(searchInput.value);
      }
      event.preventDefault();
    } else if (event.key === 'Escape') {
      hideAutocompleteList();
    }
    if (currentHighlight > -1) {
      suggestions[currentHighlight].classList.add('highlighted');
      suggestions[currentHighlight].scrollIntoView({ block: 'nearest' });
    }
  }

  // 검색 실행: 검색 API 호출 후 결과 저장 및 이동
  async function performSearch(keyword) {
    if (!keyword || keyword.trim() === '') {
      alert('검색어를 입력해주세요.');
      return;
    }
    try {
      const response = await fetch(`/api/elk/products/search/products?pname=${encodeURIComponent(keyword)}`);
      const data = await response.json();
      sessionStorage.setItem('searchResults', JSON.stringify(data.body || []));
      sessionStorage.setItem('searchKeyword', keyword);
      window.location.href = `/products/search-results?pname=${encodeURIComponent(keyword)}`;
    } catch (e) {
      alert('검색 중 오류가 발생했습니다.');
    }
  }

  searchInput.addEventListener('input', debounce((e) => {
    fetchAutocomplete(e.target.value.trim());
  }, 300));
  searchInput.addEventListener('keydown', handleKeydown);

  searchForm.addEventListener('submit', (e) => {
    e.preventDefault();
    hideAutocompleteList();
    performSearch(searchInput.value);
  });

  document.addEventListener('mousedown', (event) => {
    if (!autocompleteList.contains(event.target) && event.target !== searchInput) {
      hideAutocompleteList();
    }
  });
});
</script>
</body>
</html> 